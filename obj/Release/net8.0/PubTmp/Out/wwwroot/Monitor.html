<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoramento - Servidor Alctel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 28px;
            color: #4fc3f7;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo {
            font-weight: 700;
            color: #00bcd4;
        }

        .timestamp {
            font-size: 14px;
            color: #9e9e9e;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-online {
            background: #4caf50;
            color: #fff;
        }

        .status-offline {
            background: #f44336;
            color: #fff;
        }

        .status-warning {
            background: #ff9800;
            color: #fff;
        }

        .availability {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
        }

        .availability.high {
            color: #4caf50;
        }

        .availability.medium {
            color: #ff9800;
        }

        .availability.low {
            color: #f44336;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #9e9e9e;
            font-size: 14px;
        }

        .metric-value {
            color: #fff;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-high {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
        }

        .progress-medium {
            background: linear-gradient(90deg, #ff9800, #ffc107);
        }

        .progress-low {
            background: linear-gradient(90deg, #f44336, #e91e63);
        }

        .services-list {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .service-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .service-item.online {
            border-left-color: #4caf50;
        }

        .service-item.offline {
            border-left-color: #f44336;
        }

        .service-info {
            flex: 1;
        }

        .service-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .service-details {
            font-size: 12px;
            color: #9e9e9e;
        }

        .service-uptime {
            text-align: right;
            margin-right: 20px;
        }

        .uptime-value {
            font-size: 20px;
            font-weight: 700;
        }

        .uptime-label {
            font-size: 12px;
            color: #9e9e9e;
        }

        .chart-placeholder {
            width: 100%;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9e9e9e;
            margin-top: 15px;
        }

        .alert-section {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #ff9800;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .alert-title {
            color: #ff9800;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .alert-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin: 8px 0;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9e9e9e;
            font-size: 18px;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #f44336;
        }

        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .connection-status.online {
            background-color: #4caf50;
        }

        .connection-status.offline {
            background-color: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üñ•Ô∏è Monitoramento em Tempo Real <span class="logo">Alctel</span></h1>
            <p style="color: #9e9e9e; margin-top: 5px;">
                <span class="connection-status online" id="connectionStatus"></span>
                <span id="serverName">Carregando...</span> (<span id="serverIP">---.---.---.---</span>)
            </p>
        </div>
        <div class="timestamp">
            √öltima atualiza√ß√£o: <span id="timestamp"></span>
        </div>
    </div>

    <div id="alertSection" class="alert-section" style="display: none;">
        <div class="alert-title">‚ö†Ô∏è Alertas Ativos</div>
        <div id="alertList"></div>
    </div>

    <div id="loadingMessage" class="loading">
        ‚è≥ Carregando dados do servidor...
    </div>

    <div id="mainContent" style="display: none;">
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Disponibilidade (30 dias)</div>
                    <div class="status-badge" id="availabilityBadge">CARREGANDO</div>
                </div>
                <div class="availability high" id="availabilityPercent">--%</div>
                <div class="progress-bar">
                    <div class="progress-fill progress-high" id="availabilityBar" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Tempo Total (30d)</span>
                    <span class="metric-value" id="totalMinutes">-- min</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Downtime Total</span>
                    <span class="metric-value" id="downtimeMinutes">-- min</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Meta SLA</span>
                    <span class="metric-value" id="slaStatus">99.5%</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Status do Servidor</div>
                </div>
                <div class="metric">
                    <span class="metric-label">Status Atual</span>
                    <span class="metric-value" id="hostStatus">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Triggers Ativos</span>
                    <span class="metric-value" id="triggersTotal">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Cr√≠ticos</span>
                    <span class="metric-value" style="color: #f44336;" id="triggersCritical">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avisos</span>
                    <span class="metric-value" style="color: #ff9800;" id="triggersWarning">--</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Problemas (30 dias)</div>
                </div>
                <div class="metric">
                    <span class="metric-label">Total de Problemas</span>
                    <span class="metric-value" id="problemsTotal">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Ativos</span>
                    <span class="metric-value" style="color: #f44336;" id="problemsActive">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Resolvidos</span>
                    <span class="metric-value" style="color: #4caf50;" id="problemsResolved">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value" id="uptimeMinutes">-- min</span>
                </div>
            </div>
        </div>

        <div class="services-list">
            <h2 style="margin-bottom: 20px; color: #4fc3f7;">üõ†Ô∏è Servi√ßos Monitorados</h2>
            <div id="servicesList">
                <div class="loading">Carregando servi√ßos...</div>
            </div>
        </div>

        <div class="services-list" style="margin-top: 20px;">
            <h2 style="margin-bottom: 20px; color: #4fc3f7;">üö® Problemas Recentes (7 dias)</h2>
            <div id="problemsList">
                <div class="loading">Carregando problemas...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://status.contactfy.cloud/api';
        let updateInterval;

        // Atualiza timestamp
        function updateTimestamp() {
            const now = new Date();
            const formatted = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('timestamp').textContent = formatted;
        }

        // Busca dados do dashboard
        async function fetchDashboard() {
            try {
                const response = await fetch(`${API_BASE}/dashboard`);
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                updateDashboard(data);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                showError(`Erro ao conectar com o servidor: ${error.message}`);
            }
        }

        // Atualiza o dashboard com os dados
        function updateDashboard(data) {
            // Informa√ß√µes do host
            document.getElementById('serverName').textContent = data.host.name;
            document.getElementById('serverIP').textContent = data.host.ip;
            document.getElementById('hostStatus').textContent = data.host.status;
            
            const statusIndicator = document.getElementById('connectionStatus');
            statusIndicator.className = 'connection-status ' + (data.host.status === 'Online' ? 'online' : 'offline');

            // Disponibilidade
            const availability = data.availability.percent;
            document.getElementById('availabilityPercent').textContent = availability.toFixed(2) + '%';
            document.getElementById('availabilityBar').style.width = availability + '%';
            document.getElementById('totalMinutes').textContent = data.availability.total_minutes.toLocaleString('pt-BR') + ' min';
            document.getElementById('downtimeMinutes').textContent = data.availability.downtime_minutes.toFixed(2) + ' min';
            document.getElementById('uptimeMinutes').textContent = data.availability.uptime_minutes.toLocaleString('pt-BR') + ' min';

            // Define cor da disponibilidade
            const availElement = document.getElementById('availabilityPercent');
            const progressBar = document.getElementById('availabilityBar');
            const badge = document.getElementById('availabilityBadge');

            if (availability >= 99.5) {
                availElement.className = 'availability high';
                progressBar.className = 'progress-fill progress-high';
                badge.className = 'status-badge status-online';
                badge.textContent = 'EXCELENTE';
            } else if (availability >= 95) {
                availElement.className = 'availability medium';
                progressBar.className = 'progress-fill progress-medium';
                badge.className = 'status-badge status-warning';
                badge.textContent = 'ATEN√á√ÉO';
            } else {
                availElement.className = 'availability low';
                progressBar.className = 'progress-fill progress-low';
                badge.className = 'status-badge status-offline';
                badge.textContent = 'CR√çTICO';
            }

            // SLA Status
            const slaElement = document.getElementById('slaStatus');
            if (availability >= 99.5) {
                slaElement.style.color = '#4caf50';
                slaElement.textContent = '‚úì 99.5%';
            } else {
                slaElement.style.color = '#f44336';
                slaElement.textContent = '‚úó 99.5%';
            }

            // Triggers
            document.getElementById('triggersTotal').textContent = data.triggers.total;
            document.getElementById('triggersCritical').textContent = data.triggers.critical;
            document.getElementById('triggersWarning').textContent = data.triggers.warning;

            // Problemas
            document.getElementById('problemsTotal').textContent = data.problems.total;
            document.getElementById('problemsActive').textContent = data.problems.active;
            document.getElementById('problemsResolved').textContent = data.problems.resolved;

            // Atualiza alertas
            updateAlerts(data.triggers.critical, data.triggers.warning, data.problems.active);
        }

        // Atualiza se√ß√£o de alertas
        function updateAlerts(critical, warning, activeProblems) {
            const alertSection = document.getElementById('alertSection');
            const alertList = document.getElementById('alertList');

            if (critical > 0 || warning > 0 || activeProblems > 0) {
                alertSection.style.display = 'block';
                alertList.innerHTML = '';

                if (critical > 0) {
                    alertList.innerHTML += `<div class="alert-item">üî¥ ${critical} trigger(s) cr√≠tico(s) ativo(s)</div>`;
                }
                if (warning > 0) {
                    alertList.innerHTML += `<div class="alert-item">üü° ${warning} alerta(s) de aten√ß√£o ativo(s)</div>`;
                }
                if (activeProblems > 0) {
                    alertList.innerHTML += `<div class="alert-item">‚ö†Ô∏è ${activeProblems} problema(s) ativo(s) no momento</div>`;
                }
            } else {
                alertSection.style.display = 'none';
            }
        }

        // Busca servi√ßos monitorados
        async function fetchServices() {
            try {
                const response = await fetch(`${API_BASE}/services`);
                const services = await response.json();

                const servicesList = document.getElementById('servicesList');
                
                if (!services || services.length === 0) {
                    servicesList.innerHTML = '<div class="loading">Nenhum servi√ßo encontrado</div>';
                    return;
                }

                servicesList.innerHTML = '';
                services.forEach(service => {
                    const statusColor = service.active ? '#4caf50' : '#f44336';
                    const statusBadgeClass = service.active ? 'status-online' : 'status-offline';
                    const borderClass = service.active ? 'online' : 'offline';
                    const statusIcon = service.active ? 'üü¢' : 'üî¥';
                    
                    const serviceHtml = `
                        <div class="service-item ${borderClass}">
                            <div style="font-size: 24px; margin-right: 15px;">${statusIcon}</div>
                            <div class="service-info">
                                <div class="service-name">${service.name}</div>
                                <div class="service-details">√öltima verifica√ß√£o: ${service.lastcheck}</div>
                            </div>
                            <div class="service-uptime">
                                <div class="uptime-value" style="color: ${statusColor};">${service.status}</div>
                            </div>
                        </div>
                    `;
                    servicesList.innerHTML += serviceHtml;
                });

            } catch (error) {
                console.error('Erro ao buscar servi√ßos:', error);
                document.getElementById('servicesList').innerHTML = '<div class="loading">Erro ao carregar servi√ßos</div>';
            }
        }

        // Busca problemas recentes
        async function fetchProblems() {
            try {
                const response = await fetch(`${API_BASE}/problems`);
                const problems = await response.json();

                const problemsList = document.getElementById('problemsList');
                
                if (!problems || problems.length === 0) {
                    problemsList.innerHTML = '<div class="loading" style="color: #4caf50;">‚úì Nenhum problema recente encontrado!</div>';
                    return;
                }

                problemsList.innerHTML = '';
                problems.forEach(problem => {
                    const severityColor = {
                        '5': '#f44336',
                        '4': '#ff5722',
                        '3': '#ff9800',
                        '2': '#ffc107',
                        '1': '#4fc3f7'
                    }[problem.severity_level] || '#9e9e9e';

                    const statusBadgeClass = problem.status === 'Ativo' ? 'status-offline' : 'status-online';
                    const borderClass = problem.status === 'Ativo' ? 'offline' : 'online';

                    const problemHtml = `
                        <div class="service-item ${borderClass}">
                            <div class="service-info">
                                <div class="service-name" style="color: ${severityColor};">${problem.name}</div>
                                <div class="service-details">
                                    ${problem.severity} ‚Ä¢ Iniciado em: ${problem.started}
                                </div>
                            </div>
                            <div class="service-uptime">
                                <div class="uptime-value" style="color: ${severityColor};">${problem.duration_minutes.toFixed(0)} min</div>
                                <div class="uptime-label">Dura√ß√£o</div>
                            </div>
                            <div class="status-badge ${statusBadgeClass}">${problem.status.toUpperCase()}</div>
                        </div>
                    `;
                    problemsList.innerHTML += problemHtml;
                });

            } catch (error) {
                console.error('Erro ao buscar problemas:', error);
                document.getElementById('problemsList').innerHTML = '<div class="loading">Erro ao carregar problemas</div>';
            }
        }

        // Mostra mensagem de erro
        function showError(message) {
            const mainContent = document.getElementById('mainContent');
            const loading = document.getElementById('loadingMessage');
            
            loading.style.display = 'none';
            mainContent.style.display = 'block';
            mainContent.innerHTML = `
                <div class="error-message">
                    <h3>‚ùå Erro de Conex√£o</h3>
                    <p>${message}</p>
                    <p style="margin-top: 10px; font-size: 14px;">Verifique se o servidor Flask est√° rodando em http://localhost:5000</p>
                </div>
            `;
        }

        // Atualiza todos os dados
        async function updateAll() {
            await fetchDashboard();
            await fetchServices();
            await fetchProblems();
        }

        // Inicializa√ß√£o
        updateTimestamp();
        setInterval(updateTimestamp, 1000);

        // Primeira busca
        updateAll();

        // Atualiza a cada 30 segundos
        updateInterval = setInterval(updateAll, 30000);

        console.log('‚úì Dashboard inicializado! Atualizando a cada 30 segundos...');
    </script>
</body>
</html>
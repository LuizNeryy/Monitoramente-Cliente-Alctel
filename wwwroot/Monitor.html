<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Alctel</title>
    <link rel="icon" type="image/x-icon" href="https://alcdesk.alctel.com.br/img/favicon.ico">

    
    <!-- fontes  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração das cores -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#020617',
                        surface: '#1e293b',
                        border: '#334155',
                        primary: '#38bdf8', 
                        success: '#4ade80',
                        warning: '#fbbf24', 
                        danger: '#f87171',
                        
                        text: {
                            main: '#ffffff', 
                            secondary: '#e2e8f0', 
                            muted: '#94a3b8', 
                        }
                    },
                    boxShadow: {
                        'neon': '0 0 20px -5px rgba(56, 189, 248, 0.3)',
                        'glow': '0 0 15px rgba(56, 189, 248, 0.15)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)', 
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #0f172a;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%);
            background-attachment: fixed;
            color: theme('colors.text.main');
            min-height: 100vh;
        }
        
        /* Efeito Liquid Glass Premium (Estilo iPhone) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(20px) saturate(180%); 
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .progress-bar-fill {
            transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* Classes utilitárias de texto revisadas */
        .text-label { 
            color: #cbd5e1; 
            font-size: 0.8rem; 
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }
        
        .text-value { 
            color: #ffffff; 
            font-weight: 700; 
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="antialiased flex flex-col h-screen overflow-hidden">

    <!-- Tela de Seleção de Cliente -->
    <div id="errorScreen" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-background">
        <div class="glass-panel rounded-2xl p-8 max-w-md space-y-6">
            <div class="text-center">
                <div class="mb-4">
                    <img src="https://alctel.com.br/wp-content/uploads/2025/10/logo_Prancheta-1.png" alt="Alctel" class="h-16 mx-auto">
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">Monitoramento Alctel</h1>
            </div>
            
            <form onsubmit="validarCliente(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-300 mb-2 uppercase tracking-wide">Nome do Cliente Alctel:</label>
                    <input 
                        type="text" 
                        id="clienteInput"
                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                        autocomplete="off"
                        autofocus
                    />
                </div>
                <div id="errorMessage" class="hidden p-3 bg-red-500/20 border border-red-500/30 rounded-lg">
                    <p class="text-red-400 text-sm font-medium flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        <span id="errorText">Cliente não encontrado</span>
                    </p>
                </div>
                <button 
                    type="submit"
                    id="submitBtn"
                    class="w-full py-3 bg-primary hover:bg-primary/80 text-white font-bold rounded-lg transition-all active:scale-95 shadow-lg hover:shadow-primary/20"
                >
                    Acessar Monitoramento
                </button>
            </form>
            
            <script>
                async function validarCliente(event) {
                    event.preventDefault();
                    const cliente = document.getElementById('clienteInput').value.trim();
                    const errorDiv = document.getElementById('errorMessage');
                    const errorText = document.getElementById('errorText');
                    const submitBtn = document.getElementById('submitBtn');
                    
                    if (!cliente) return;
                    
                    errorDiv.classList.add('hidden');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Verificando...';
                    
                    try {
                        const response = await fetch(`/api/clients`);
                        const data = await response.json();
                        
                        // Busca case-insensitive
                        const clienteLower = cliente.toLowerCase();
                        const clienteEncontrado = data.clients?.find(c => c.toLowerCase() === clienteLower);
                        
                        if (clienteEncontrado) {
                            window.location.href = `?cliente=${clienteEncontrado}`; 
                        } else {
                            errorText.textContent = `Cliente '${cliente}' não encontrado`;
                            errorDiv.classList.remove('hidden');
                            lucide.createIcons();
                        }
                    } catch (error) {
                        errorText.textContent = 'Erro ao verificar cliente';
                        errorDiv.classList.remove('hidden');
                        lucide.createIcons();
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Acessar Monitoramento';
                    }
                }
            </script>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-header h-20 shrink-0 z-50 fixed top-0 w-full">
        <div class="h-full max-w-[1600px] mx-auto px-6 flex items-center justify-between">
            
            <!-- Logo -->
            <div class="flex items-center gap-3 w-1/4">
                <img src="https://alctel.com.br/wp-content/uploads/2025/10/logo_Prancheta-1.png" alt="Alctel" class="h-12 w-auto">
            </div>

            <!-- Server Name Central -->
            <div class="flex flex-col items-center justify-center w-2/4">
                <div class="flex items-center gap-3 px-5 py-1.5 bg-white/5 rounded-full border border-white/10 shadow-lg backdrop-blur-md group hover:bg-white/10 transition-colors cursor-default">
                    <div class="relative flex h-2.5 w-2.5">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75" id="pingIndicator"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500" id="staticIndicator"></span>
                    </div>
                    <span class="font-mono text-sm font-bold text-white tracking-wide group-hover:text-primary transition-colors" id="serverName">SRV-MAIN-01</span>
                </div>
                <span class="text-[10px] text-slate-300 mt-1 font-medium tracking-wide" id="connectionText">Conexão Estável</span>
                <span id="hostStatus" class="hidden">--</span> 
            </div>

            <!-- Controles -->
            <div class="flex items-center justify-end gap-6 w-1/4">
                <div class="text-right">
                    <p class="text-[10px] text-slate-300 uppercase tracking-wider font-bold">Cliente</p>
                    <p class="text-sm font-mono text-primary font-medium" id="clientNameDisplay">--</p>
                </div>
                <div class="text-right sm:block">
                    <p class="text-[10px] text-slate-300 uppercase tracking-wider font-bold">Atualizado às</p>
                    <p class="text-sm font-mono text-white font-medium" id="timestamp">--:--:--</p>
                </div>
                <button onclick="fazerLogout()" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition flex items-center gap-2 border border-red-500/30" title="Sair">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span class="text-sm font-medium">Sair</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto mt-20 p-6 scroll-smooth">
        <div class="max-w-[1600px] mx-auto space-y-6">

            <!-- Grid de Cards (3 Colunas) -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                
                <!-- CARD 1: Disponibilidade (30 dias) -->
                <div class="md:col-span-4 glass-panel rounded-2xl p-6 relative overflow-hidden group hover:bg-white/5 transition-all duration-300 h-full flex flex-col">
                    <!-- Efeito de brilho de fundo sutil -->
                    <div class="absolute -right-12 -top-12 w-48 h-48 bg-primary/10 rounded-full blur-[80px] pointer-events-none"></div>
                    
                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <div class="flex items-center gap-2 text-slate-200">
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-primary"></i>
                            <span class="text-sm font-bold tracking-wide">Disponibilidade (30 dias)</span>
                        </div>
                        <span id="availabilityBadge" class="px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider border transition-colors bg-white/5 border-white/10 text-slate-300 backdrop-blur-md">
                            --
                        </span>
                    </div>

                    <div class="flex items-baseline gap-2 mb-2 relative z-10">
                        <span class="text-5xl font-bold text-white tracking-tight drop-shadow-md" id="availabilityPercent">--%</span>
                        <span class="text-xs text-slate-400 font-medium uppercase tracking-wider">disp. 30 dias</span>
                    </div>

                    <div class="w-full bg-white/5 rounded-full h-2.5 mb-6 overflow-hidden relative border border-white/5">
                        <div id="availabilityBar" class="h-full rounded-full relative shadow-[0_0_15px_currentColor] progress-bar-fill bg-emerald-500 text-emerald-500" style="width: 0%"></div>
                    </div>

                    <!-- Dados Detalhados -->
                    <div class="grid grid-cols-2 gap-y-6 gap-x-4 pt-4 border-t border-white/10 relative z-10">
                        <div>
                            <p class="text-label mb-1">Tempo Total (30d)</p>
                            <p class="text-value text-lg" id="totalMinutes">--</p>
                        </div>
                        <div>
                            <p class="text-label mb-1 text-emerald-300/80">Uptime Real</p>
                            <p class="text-value text-lg text-emerald-400" id="uptimeMinutes">--</p>
                        </div>
                        <div>
                            <p class="text-label mb-1">Meta SLA</p>
                            <p class="text-value text-base" id="slaStatus">99.5%</p>
                        </div>
                        <div>
                            <p class="text-label mb-1 text-red-300/80">Downtime</p>
                            <p class="text-value text-base text-red-400" id="downtimeMinutes">--</p>
                        </div>
                    </div>
                </div>

                <!-- CARD 2: Problemas (30 dias) - CORRIGIDO O ALINHAMENTO INTERNO -->
                <div class="md:col-span-4 glass-panel rounded-2xl p-6 hover:bg-white/5 transition-all duration-300 relative overflow-hidden h-full flex flex-col">
                    <div class="absolute -left-12 -bottom-12 w-48 h-48 bg-red-500/5 rounded-full blur-[80px] pointer-events-none"></div>

                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <div class="flex items-center gap-2 text-slate-200">
                            <i data-lucide="activity-square" class="w-4 h-4 text-primary"></i>
                            <span class="text-sm font-bold tracking-wide">Resumo de Problemas</span>
                        </div>
                    </div>

                    <!-- CORREÇÃO: Removendo classes flex/h-full para deixar o conteúdo compacto no topo. -->
                    <div class="space-y-4 relative z-10">
                        <div class="grid grid-cols-3 gap-3">
                            <!-- Problemas Totais -->
                            <div class="p-4 rounded-xl bg-white/5 border border-white/10 text-center flex flex-col justify-center backdrop-blur-md hover:bg-white/10 transition-colors">
                                <span class="block text-[10px] font-bold uppercase text-slate-300 mb-1">Total</span>
                                <span class="block text-2xl font-bold text-white" id="problemsTotal">--</span>
                            </div>
                            <!-- Problemas Ativos -->
                            <div class="relative p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-center flex flex-col justify-center backdrop-blur-md">
                                <span class="block text-[10px] font-bold uppercase text-red-300 mb-1">Ativos</span>
                                <span class="block text-2xl font-bold text-red-400" id="problemsActive">--</span>
                                <!-- Ponto de alerta animado (reposicionado aqui) -->
                                <div class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse shadow-lg" id="activeDot" style="display:none"></div>
                            </div>
                            <!-- Problemas Resolvidos -->
                            <div class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-center flex flex-col justify-center backdrop-blur-md">
                                <span class="block text-[10px] font-bold uppercase text-emerald-300 mb-1">Resolvidos</span>
                                <span class="block text-2xl font-bold text-emerald-400" id="problemsResolved">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rodapé ajustado -->
                    <div class="text-center mt-6 pt-4 relative z-10 border-t border-white/10">
                        <p class="text-xs text-slate-400 font-medium">Janela de monitoramento: <span class="text-white font-bold">Últimos 30 dias</span></p>
                    </div>
                </div>

                <!-- CARD 3: Problemas Ativos (LISTA) - CORRIGIDA ESTILIZAÇÃO DO HEADER -->
                <div class="md:col-span-4 glass-panel rounded-2xl flex flex-col h-[400px] overflow-hidden h-full">
                    <!-- CORREÇÃO: Removendo bg-white/5 backdrop-blur-md para ficar mais liso -->
                    <div class="p-5 border-b border-white/10 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-white flex items-center gap-2.5 text-sm tracking-wide">
                            <i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>
                            Problemas Ativos
                        </h3>
                        <span class="text-[10px] text-slate-300 uppercase font-bold tracking-wider bg-red-500/20 border border-red-500/30 px-2 py-1 rounded backdrop-blur-md" id="activeProblemsCountTop">0</span>
                    </div>

                    <div class="flex-1 overflow-y-auto p-3 space-y-2" id="problemsListTop">
                        <!-- Conteúdo carregado pelo JS (fetchProblems) -->
                        <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-3">
                            <i data-lucide="check-circle" class="w-12 h-12 text-emerald-500/30"></i>
                            <span class="text-sm font-medium">Nenhum problema ativo</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Hidden ID anchors to prevent JS errors (fora da grid) -->
            <span id="hostStatus" style="display:none"></span>
            <span id="triggersTotal" style="display:none"></span>
            <span id="triggersCritical" style="display:none"></span>
            <span id="triggersWarning" style="display:none"></span>

            <!-- CARD 4: Downtime Report (30 dias) -->
            <div class="glass-panel rounded-2xl p-6 hover:bg-white/5 transition-all duration-300 relative overflow-hidden">
                <div class="absolute -right-12 -top-12 w-48 h-48 bg-amber-500/5 rounded-full blur-[80px] pointer-events-none"></div>
                
                <div class="flex justify-between items-start mb-6 relative z-10">
                    <div class="flex items-center gap-2 text-slate-200">
                        <i data-lucide="clock" class="w-4 h-4 text-amber-400"></i>
                        <span class="text-sm font-bold tracking-wide">Análise de Downtime (30 dias)</span>
                    </div>
                    <div class="px-3 py-1.5 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 text-xs font-bold uppercase tracking-wider flex items-center gap-2 backdrop-blur-md">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        Atualização automática
                    </div>
                </div>

                <div id="downtimeContent" class="relative z-10">
                    <div class="flex flex-col items-center justify-center h-32 text-slate-400 gap-3">
                        <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-amber-400/50"></i>
                        <span class="text-sm font-medium">Carregando análise de downtime...</span>
                    </div>
                </div>

                <div id="downtimeDetails" class="hidden relative z-10">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10 backdrop-blur-md">
                            <p class="text-label mb-1">Total Downtime</p>
                            <p class="text-value text-2xl text-red-400" id="totalDowntime">--</p>
                        </div>
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10 backdrop-blur-md">
                            <p class="text-label mb-1">Serviços</p>
                            <p class="text-value text-2xl" id="servicesCount">--</p>
                        </div>
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10 backdrop-blur-md">
                            <p class="text-label mb-1">Com Downtime</p>
                            <p class="text-value text-2xl text-amber-400" id="servicesWithDowntime">--</p>
                        </div>
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10 backdrop-blur-md">
                            <p class="text-label mb-1">Disponibilidade</p>
                            <p class="text-value text-2xl text-emerald-400" id="downtimeAvailability">--</p>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-white/10">
                        <button 
                            onclick="toggleDowntimeDetails()" 
                            class="w-full py-2 px-4 rounded-lg bg-white/5 border border-white/10 text-slate-300 text-xs font-bold uppercase tracking-wider hover:bg-white/10 transition-all flex items-center justify-center gap-2"
                        >
                            <i data-lucide="chevron-down" class="w-4 h-4" id="downtimeToggleIcon"></i>
                            <span id="downtimeToggleText">Ver Detalhes por Serviço</span>
                        </button>
                        <div id="downtimeServicesList" class="hidden mt-4 space-y-2 max-h-96 overflow-y-auto">
                            <!-- Será preenchido dinamicamente -->
                        </div>
                    </div>

                    <div class="text-center mt-4 pt-4 border-t border-white/10">
                        <p class="text-xs text-slate-400">Última atualização: <span class="text-white font-mono" id="downtimeGeneratedAt">--</span></p>
                    </div>
                </div>
            </div>

            <!-- Listas (Agora apenas a Lista de Serviços, ocupando 100%) -->
            <div class="grid grid-cols-1 gap-6 pb-6">
                
                <!-- Lista de Serviços (Ocupa 100% da largura) -->
                <!-- CORREÇÃO: Removendo h-[400px] para que ele use o espaço flexível do main -->
                <div class="glass-panel rounded-2xl flex flex-col overflow-hidden">
                    <!-- CORREÇÃO: Removendo bg-white/5 backdrop-blur-md para ficar mais liso -->
                    <div class="p-5 border-b border-white/10 flex justify-between items-center shrink-0">
                        <h3 class="font-bold text-white flex items-center gap-2.5 text-sm tracking-wide">
                            <i data-lucide="layers" class="w-4 h-4 text-primary"></i>
                            Serviços Monitorados
                        </h3>
                        <div id="servicesCounter" class="text-xs font-mono font-bold px-3 py-1.5 rounded bg-black/20 border border-white/10 text-slate-300 backdrop-blur-md">-- / --</div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-3 space-y-2" id="servicesList">
                        <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-3">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-primary/50"></i>
                            <span class="text-sm font-medium">Carregando serviços...</span>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <script>
        // ===== VERIFICAÇÃO DE AUTENTICAÇÃO (EXECUTADA IMEDIATAMENTE) =====
        (async function() {
            const token = localStorage.getItem('token');
            const storedClientId = localStorage.getItem('clientId');
            const storedClientName = localStorage.getItem('clientName');
            
            // Verifica se está autenticado
            if (!token || !storedClientId) {
                // Não está autenticado, limpa tudo e redireciona para login
                localStorage.clear();
                window.location.replace('/login.html');
                return;
            }
            
            // Verifica se o token ainda é válido localmente
            const expiresAt = localStorage.getItem('expiresAt');
            if (expiresAt && new Date(expiresAt) < new Date()) {
                // Token expirado
                localStorage.clear();
                alert('Sua sessão expirou. Faça login novamente.');
                window.location.replace('/login.html');
                return;
            }
            
            // Valida o token com o backend
            try {
                const response = await fetch('/api/auth/validate', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Token inválido no backend
                    localStorage.clear();
                    alert('Sessão inválida. Faça login novamente.');
                    window.location.replace('/login.html');
                    return;
                }
            } catch (error) {
                // Erro ao validar token
                console.error('Erro ao validar token:', error);
                localStorage.clear();
                alert('Erro ao validar sessão. Faça login novamente.');
                window.location.replace('/login.html');
                return;
            }
            
            // Verifica se o clientId da URL corresponde ao cliente do token
            const urlParams = new URLSearchParams(window.location.search);
            const urlClientId = urlParams.get('cliente');
            
            if (urlClientId && urlClientId !== storedClientId) {
                // Tentando acessar outro cliente
                localStorage.clear();
                alert('Acesso não autorizado. Você não tem permissão para acessar este cliente.');
                window.location.replace('/login.html');
                return;
            }
            
            // Se não tiver clientId na URL, adiciona o correto
            if (!urlClientId) {
                window.location.replace(`/Monitor.html?cliente=${storedClientId}`);
                return;
            }
            
            // Exibe o nome do cliente no header imediatamente
            const clientNameElement = document.getElementById('clientNameDisplay');
            if (clientNameElement) {
                clientNameElement.textContent = storedClientName || storedClientId;
            }
        })();
        // ===== FIM VERIFICAÇÃO DE AUTENTICAÇÃO =====
        
        // Inicializa os ícones do Lucide
        lucide.createIcons();
        
        // Funções de Autenticação/Inicialização
        async function validarCliente(event) {
            event.preventDefault();
            const cliente = document.getElementById('clienteInput').value.trim();
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const submitBtn = document.getElementById('submitBtn');
            if (!cliente) return;
            errorDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Verificando...';
            try {
                const response = await fetch(`/api/clients`);
                const data = await response.json();
                // Busca case-insensitive
                const clienteLower = cliente.toLowerCase();
                const clienteEncontrado = data.clients?.find(c => c.toLowerCase() === clienteLower);
                if (clienteEncontrado) {
                    window.location.href = '/' + clienteEncontrado;
                } else {
                    errorText.textContent = `Cliente '${cliente}' não encontrado`;
                    errorDiv.classList.remove('hidden');
                    lucide.createIcons();
                }
            } catch (error) {
                errorText.textContent = 'Erro ao verificar cliente';
                errorDiv.classList.remove('hidden');
                lucide.createIcons();
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Acessar Monitoramento';
            }
        }

        // Detecta o clienteId da URL ou do localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('cliente') || localStorage.getItem('clientId') || '';

        // Se não houver clientId, mostra tela para digitar o nome do cliente
        if (!clientId) {
            document.getElementById('errorScreen').classList.remove('hidden');
            document.querySelector('header').style.display = 'none';
            document.querySelector('main').style.display = 'none';
            lucide.createIcons();
        } else {
            document.getElementById('errorScreen').classList.add('hidden');
        }

        // Só define API_BASE se houver clientId
        const API_BASE = clientId ? `/api/${clientId}` : null;
        
        // Cache de ETags para conditional requests
        const etagCache = {};
        
        // Função helper para fazer requisições autenticadas com suporte a ETag
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            
            // Adiciona ETag se já temos uma versão cacheada
            if (etagCache[url]) {
                headers['If-None-Match'] = etagCache[url];
            }
            
            const response = await fetch(url, { ...options, headers });
            
            // Se retornar 401 (não autorizado), redireciona para login
            if (response.status === 401) {
                localStorage.clear();
                alert('Sua sessão expirou. Faça login novamente.');
                window.location.href = '/login.html';
                throw new Error('Não autorizado');
            }
            
            // Se retornar 304 (Not Modified), dados não mudaram
            if (response.status === 304) {
                console.log(`[CACHE] Dados não modificados: ${url}`);
                return { notModified: true };
            }
            
            // Armazena ETag para próximas requisições
            const etag = response.headers.get('ETag');
            if (etag) {
                etagCache[url] = etag;
            }
            
            return response;
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleString('pt-BR', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        async function fetchDashboard() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/dashboard`);
                
                // Se retornou 304 (dados não modificados), não precisa re-renderizar
                if (response.notModified) {
                    console.log('[CACHE] Dashboard não modificado, mantendo exibição atual');
                    return;
                }
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // Armazena dados globalmente para uso em outros lugares
                window.dashboardData = data;

                // Usa os valores que já vêm do dashboard (do JSON)
                // Não precisa mais fazer chamadas extras para /problems

                renderDashboard(data);
            } catch (error) {
                console.error("Erro ao buscar dashboard:", error);
                // Não marca como offline - pode ser erro temporário
            }
        }

        function renderDashboard(data) {
            // 1. Header Status
            document.getElementById('serverName').textContent = data.host.name;
            document.getElementById('hostStatus').textContent = data.host.status;
            
            const isOnline = data.host.status === 'Online';
            const connText = document.getElementById('connectionText');
            connText.textContent = isOnline ? 'Conexão Estável' : 'Falha na Conexão';
            connText.className = isOnline ? 'text-[10px] text-emerald-400 mt-1 font-bold uppercase tracking-wider' : 'text-[10px] text-red-400 mt-1 font-bold uppercase tracking-wider';

            const ping = document.getElementById('pingIndicator');
            const staticDot = document.getElementById('staticIndicator');
            
            if(isOnline) {
                ping.classList.remove('bg-red-400'); ping.classList.add('bg-emerald-400', 'animate-ping');
                staticDot.classList.remove('bg-red-500'); staticDot.classList.add('bg-emerald-500');
            } else {
                ping.classList.remove('bg-emerald-400', 'animate-ping'); ping.classList.add('bg-red-400');
                staticDot.classList.remove('bg-emerald-500'); staticDot.classList.add('bg-red-500');
            }

            // 2. Card 1: Disponibilidade
            const avail = data.availability.percent;
            document.getElementById('availabilityPercent').textContent = avail.toFixed(2) + '%';
            document.getElementById('availabilityBar').style.width = avail + '%';

            const bar = document.getElementById('availabilityBar');
            const badge = document.getElementById('availabilityBadge');
            
            bar.className = 'h-full rounded-full relative shadow-[0_0_15px_currentColor] progress-bar-fill';
            
            if (avail >= 99.5) {
                bar.classList.add('bg-emerald-500', 'text-emerald-500');
                badge.className = 'px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider border bg-emerald-500/10 border-emerald-500/30 text-emerald-400 shadow-[0_0_10px_rgba(16,185,129,0.1)]';
                badge.textContent = 'Excelente';
            } else if (avail >= 95) {
                bar.classList.add('bg-amber-500', 'text-amber-500');
                badge.className = 'px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider border bg-amber-500/10 border-amber-500/30 text-amber-400';
                badge.textContent = 'Degradado';
            } else {
                bar.classList.add('bg-red-500', 'text-red-500');
                badge.className = 'px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider border bg-red-500/10 border-red-500/30 text-red-400';
                badge.textContent = 'Crítico';
            }

            document.getElementById('totalMinutes').textContent = Math.round(data.availability.total_minutes).toLocaleString('pt-BR') + ' min';
            document.getElementById('uptimeMinutes').textContent = Math.round(data.availability.uptime_minutes).toLocaleString('pt-BR') + ' min';
            document.getElementById('downtimeMinutes').textContent = Math.round(data.availability.downtime_minutes) + ' min';

            // 3. Card 2 (Meio): Problemas (30 dias) - Estilizado
            document.getElementById('problemsTotal').textContent = data.problems.total;
            document.getElementById('problemsActive').textContent = data.problems.active;
            document.getElementById('problemsResolved').textContent = data.problems.resolved;
            
            // Ponto de alerta no Card de Problemas Ativos
            const activeDot = document.getElementById('activeDot');
            activeDot.style.display = data.problems.active > 0 ? 'block' : 'none';
            
            // 4. Atualiza o card de Problemas Ativos (card 3) com os mesmos dados
            document.getElementById('activeProblemsCountTop').textContent = data.problems.active;
            
            const list = document.getElementById('problemsListTop');
            if (data.problems.active === 0) {
                list.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-slate-400 gap-3">
                        <i data-lucide="check-circle" class="w-12 h-12 text-emerald-500/30"></i>
                        <span class="text-sm font-medium">Nenhum problema ativo</span>
                    </div>`;
                lucide.createIcons();
            } else {
                // Se tiver problemas ativos, busca detalhes do endpoint /problems
                fetchProblemsDetails();
            }

            // updateAlerts() removida - não é mais necessária
        }

        async function fetchServices() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/services`);
                
                // Se retornou 304 (dados não modificados), não precisa re-renderizar
                if (response.notModified) {
                    console.log('[CACHE] Serviços não modificados, mantendo exibição atual');
                    return;
                }
                
                const services = await response.json() || [];
                
                // Cache global para uso em outros lugares
                window.cachedServices = services;
                
                const list = document.getElementById('servicesList');
                const counter = document.getElementById('servicesCounter');

                if (services.length === 0) {
                    list.innerHTML = '<div class="p-4 text-center text-xs text-slate-400">Nenhum serviço.</div>';
                    counter.innerHTML = `0 / 0`;
                    return;
                }

                const active = services.filter(s => s.active).length;
                const inactive = services.length - active;
                counter.innerHTML = `<span class="text-emerald-400 font-bold">${active}</span> <span class="text-slate-600 mx-1">|</span> <span class="text-red-400 font-bold">${inactive}</span>`;

                list.innerHTML = '';
                services.forEach(s => {
                    const statusClass = s.active 
                        ? 'border-l-emerald-500 bg-emerald-500/5 hover:bg-emerald-500/10' 
                        : 'border-l-red-500 bg-red-500/5 hover:bg-red-500/10';
                    
                    const icon = s.active 
                        ? `<i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-400"></i>`
                        : `<i data-lucide="x-circle" class="w-5 h-5 text-red-400"></i>`;

                    list.innerHTML += `
                        <div class="p-3.5 rounded-r-xl border-l-[3px] border-y border-r border-white/5 hover:border-white/10 transition-all flex items-center justify-between group mb-1 ${statusClass} backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <div class="shrink-0">${icon}</div>
                                <div>
                                    <p class="text-sm font-bold text-slate-200 group-hover:text-white transition-colors">${s.name}</p>
                                    <p class="text-[10px] text-slate-500 font-mono mt-0.5">Last check: ${s.lastcheck}</p>
                                </div>
                            </div>
                            <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md bg-black/20 ${s.active ? 'text-emerald-400' : 'text-red-400'}">
                                ${s.status}
                            </span>
                        </div>
                    `;
                });
                lucide.createIcons();
            } catch(e) { console.log("Erro ao buscar services:", e); }
        }

        async function fetchProblemsDetails() {
            try {
                const response = await fetch(`${API_BASE}/problems`);
                const problems = await response.json() || [];
                // Atualizamos a lista no Card 3 do topo
                const list = document.getElementById('problemsListTop'); 
                
                // Backend já retorna apenas problemas ativos
                const activeProblems = problems;

                if (activeProblems.length === 0) {
                    list.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-slate-400 gap-3">
                            <i data-lucide="check-circle" class="w-12 h-12 text-emerald-500/30"></i>
                            <span class="text-sm font-medium">Nenhum problema ativo</span>
                        </div>`;
                    lucide.createIcons();
                    return;
                }

                list.innerHTML = '';
                activeProblems.forEach(p => {
                    const sevMap = {
                        '5': { c: 'text-red-400', b: 'bg-red-500/10 border-red-500/30', i: 'alert-triangle' },
                        '4': { c: 'text-orange-400', b: 'bg-orange-500/10 border-orange-500/30', i: 'alert-triangle' },
                        '3': { c: 'text-amber-400', b: 'bg-amber-500/10 border-amber-500/30', i: 'alert-circle' },
                        '2': { c: 'text-yellow-400', b: 'bg-yellow-500/10 border-yellow-500/30', i: 'alert-circle' },
                        '1': { c: 'text-blue-400', b: 'bg-blue-500/10 border-blue-500/30', i: 'info' }
                    };
                    const style = sevMap[p.severity_level] || { c: 'text-slate-400', b: 'bg-slate-800 border-slate-700', i: 'info' };

                    list.innerHTML += `
                        <div class="p-3.5 rounded-xl border border-white/5 bg-white/5 hover:bg-white/10 hover:border-white/20 transition-all mb-1 backdrop-blur-sm">
                            <div class="flex justify-between items-start mb-1.5">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border ${style.b} ${style.c}">
                                    ${p.severity}
                                </span>
                                <span class="text-[10px] font-mono font-bold text-slate-500 bg-black/20 px-1.5 py-0.5 rounded">${Math.round(p.duration_minutes)} min</span>
                            </div>
                            <p class="text-xs font-bold text-slate-200 mt-1 line-clamp-1 flex items-center gap-2" title="${p.name}">
                                <i data-lucide="${style.i}" class="w-3.5 h-3.5 ${style.c}"></i>
                                ${p.name}
                            </p>
                            <p class="text-[10px] text-slate-500 mt-0.5 font-medium">Início: ${p.started}</p>
                        </div>
                    `;
                });
                lucide.createIcons();
            } catch(e) { console.log("Erro ao buscar problems:", e); }
        }

        function setOfflineMode() {
            document.getElementById('connectionText').textContent = 'DESCONECTADO';
            document.getElementById('connectionText').className = 'text-[10px] text-red-500 mt-1 font-bold tracking-widest';
            document.getElementById('serverName').classList.add('text-red-400');
            const ping = document.getElementById('pingIndicator');
            ping.classList.remove('bg-emerald-400', 'animate-ping'); ping.classList.add('bg-red-500');
        }

        // ===== FUNÇÕES DE DOWNTIME =====
        
        async function fetchDowntimeSummary() {
            try {
                // Usa dados do dashboard (Card 1) para garantir consistência
                const dashData = window.dashboardData;
                
                if (!dashData) {
                    console.log('[DOWNTIME] Aguardando dados do dashboard...');
                    document.getElementById('downtimeContent').innerHTML = `
                        <div class="flex flex-col items-center justify-center h-32 text-slate-400 gap-3">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-amber-400/50"></i>
                            <span class="text-sm font-medium">Carregando análise...</span>
                        </div>`;
                    lucide.createIcons();
                    return;
                }
                
                // Busca relatório para pegar detalhes dos serviços
                const reportResponse = await fetchWithAuth(`${API_BASE}/downtime/report`);
                
                // Se retornou 304 (dados não modificados), não precisa re-renderizar
                if (reportResponse.notModified) {
                    console.log('[CACHE] Relatório de downtime não modificado, mantendo exibição atual');
                    return;
                }
                const reportData = await reportResponse.json();
                
                if (reportData && reportData.client_id) {
                    window.downtimeServiceDetails = reportData.services || [];

                    // Busca serviços REAIS do Zabbix (lista de serviços monitorados)
                    const services = window.cachedServices || [];

                    renderDowntimeSummary({
                        totalDowntime: Math.round(dashData.availability.downtime_minutes) + ' min',
                        servicesCount: services.length,
                        servicesWithDowntime: reportData.services_with_downtime || 0,
                        availability: dashData.availability.percent,
                        generatedAt: reportData.generated_at || new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('[DOWNTIME] Erro:', error);
                document.getElementById('downtimeContent').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-32 text-slate-400 gap-3">
                        <i data-lucide="clock" class="w-8 h-8"></i>
                        <span class="text-sm font-medium">Aguardando dados...</span>
                    </div>`;
                lucide.createIcons();
            }
        }

        function renderDowntimeSummary(data) {
            document.getElementById('downtimeContent').classList.add('hidden');
            document.getElementById('downtimeDetails').classList.remove('hidden');

            document.getElementById('totalDowntime').textContent = data.totalDowntime || '0m';
            document.getElementById('servicesCount').textContent = data.servicesCount || '0';
            document.getElementById('servicesWithDowntime').textContent = data.servicesWithDowntime || '0';
            document.getElementById('downtimeAvailability').textContent = (data.availability || 100).toFixed(2) + '%';
            
            const generatedAt = new Date(data.generatedAt);
            document.getElementById('downtimeGeneratedAt').textContent = generatedAt.toLocaleString('pt-BR');

            lucide.createIcons();
        }

        async function toggleDowntimeDetails() {
            const list = document.getElementById('downtimeServicesList');
            const icon = document.getElementById('downtimeToggleIcon');
            const text = document.getElementById('downtimeToggleText');

            if (list.classList.contains('hidden')) {
                // Mostrar detalhes
                if (!window.downtimeServiceDetails) {
                    // Buscar detalhes completos
                    try {
                        const response = await fetch(`${API_BASE}/downtime/report`);
                        
                        // Se 304, usar dados cacheados
                        if (response.status === 304) {
                            console.log('[CACHE] Usando dados cacheados do relatório');
                            return;
                        }
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        window.downtimeServiceDetails = data.services || [];
                    } catch (error) {
                        console.error("Erro ao buscar detalhes:", error);
                        list.innerHTML = `
                            <div class="p-4 text-center text-xs text-red-400">
                                Erro ao carregar detalhes. Tente recalcular o relatório.
                            </div>`;
                        list.classList.remove('hidden');
                        return;
                    }
                }

                renderDowntimeServicesList();
                list.classList.remove('hidden');
                icon.setAttribute('data-lucide', 'chevron-up');
                text.textContent = 'Ocultar Detalhes';
            } else {
                // Ocultar detalhes
                list.classList.add('hidden');
                icon.setAttribute('data-lucide', 'chevron-down');
                text.textContent = 'Ver Detalhes por Serviço';
            }

            lucide.createIcons();
        }

        function renderDowntimeServicesList() {
            const list = document.getElementById('downtimeServicesList');
            const services = window.downtimeServiceDetails || [];

            if (services.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-xs text-slate-400">Nenhum serviço encontrado.</div>';
                return;
            }

            list.innerHTML = '';
            services.forEach(service => {
                const hasDowntime = service.total_downtime_seconds > 0;
                const borderClass = hasDowntime ? 'border-l-amber-500' : 'border-l-emerald-500';
                const bgClass = hasDowntime ? 'bg-amber-500/5' : 'bg-emerald-500/5';

                const incidentsHtml = service.incidents && service.incidents.length > 0
                    ? `<div class="mt-2 pt-2 border-t border-white/5 space-y-1">
                        ${service.incidents.slice(0, 3).map(inc => `
                            <div class="text-xs text-slate-400 flex justify-between items-center">
                                <span>
                                    ${new Date(inc.start_time).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}
                                    ${inc.is_active ? '<span class="text-red-400 font-bold ml-2">ATIVO</span>' : ''}
                                </span>
                                <span class="font-mono font-bold">${inc.duration_formatted}</span>
                            </div>
                        `).join('')}
                        ${service.incidents.length > 3 ? `<div class="text-xs text-slate-500 text-center">... e mais ${service.incidents.length - 3} incidente(s)</div>` : ''}
                    </div>`
                    : '';

                list.innerHTML += `
                    <div class="p-3.5 rounded-r-xl border-l-[3px] border-y border-r border-white/5 ${borderClass} ${bgClass} backdrop-blur-sm">
                        <div class="flex items-center justify-between mb-1">
                            <p class="text-sm font-bold text-slate-200">${service.service_name}</p>
                            <span class="text-xs font-mono font-bold ${hasDowntime ? 'text-amber-400' : 'text-emerald-400'}">
                                ${service.total_downtime_formatted}
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-slate-500">${service.incident_count} incidente(s)</span>
                        </div>
                        ${incidentsHtml}
                    </div>
                `;
            });

            lucide.createIcons();
        }

        async function updateAll() {
            if (!clientId) return; // Não atualiza se não tiver cliente selecionado
            
            console.log('[UPDATE] Iniciando atualização automática...');
            
            // Atualiza dashboard com todos os dados
            await fetchDashboard();
            
            // Atualiza o Card 4 (Downtime Summary) - CRÍTICO para tempo real
            await fetchDowntimeSummary();
            
            // Atualiza serviços apenas se o card estiver visível
            if (document.getElementById('servicesList').offsetParent !== null) {
                await fetchServices();
            }
            
            lucide.createIcons();
        }

        updateTimestamp();
        setInterval(updateTimestamp, 1000);
        
        // Função de logout
        function fazerLogout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.clear();
                window.location.href = '/login.html';
            }
        }
        
        // Carrega TODOS os dados na inicialização
        (async function init() {
            console.log('[INIT] Carregando dados iniciais...');
            await fetchDashboard();
            await fetchServices();
            await fetchDowntimeSummary();
            lucide.createIcons();
        })();
        
        // Atualiza a cada 1 minuto (60 segundos) - sincronizado com BackgroundService
        setInterval(updateAll, 60000);
        
        // Garante que todos os ícones foram criados (incluindo botão de logout)
        lucide.createIcons();

    </script>
</body>
</html>